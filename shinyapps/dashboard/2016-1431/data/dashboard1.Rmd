---
title: "Project #2017-1762"
runtime: shiny
output: 
  flexdashboard::flex_dashboard:
    orientation: rows
    social: menu
    vertical_layout: fill
    theme: cerulean
    logo: heear.png
    source_code: https://urldefense.proofpoint.com/v2/url?u=https-3A__github.com_sallietsang&d=DwIGaQ&c=shNJtf5dKgNcPZ6Yh64b-ALLUrcfR-4CCQkZVKC8w3o&r=dBSsZgqxtO-ClnLzRxog8FGbomoH4dWCe7-KTJn0zIU&m=yrOE8PS2fIO-8swy1P3Vj8mZBm7zQoRtmN0RAHJhMbsbi9vhcR64XBwegYu_sNfO&s=cp_dON7XMVPkPiC9TmYRLvjO4jdMUWmR0vCDLer3TRw&e= 
---

```{r setup, include=FALSE}
#library(tidyverse)
library(tidyr)
library(dplyr)
library(plotly)
library(ggplot2)
library(flexdashboard)
library(DT)
```

```{r load data}
shiny_app_data = read.csv("shiny_app_data.csv")
clean_data = read.csv("clean_data.csv")
```

```{r option, include=FALSE}
categorical_variable = c("caregiver_sex","caregiver_treatment_group", "caregiver_race", "caregiver_age", "caregiver_education",  "caregiver_smoking_status","caregiver_household","caregiver_relation", "child_race", "child_sex", "birth_outcome")
biomarker_type= c("c_reactive_protein(pg/mL)", "interleukin_8(pg/mL)", "interleukin_10(pg/mL)","cotinine(ng/mL)", "mean_cotinine(ng/mL)")
Time = c("baseline", "followup")
```


Overview
===================================== 

Inputs {.sidebar}
-----------------------------------------------------------------------
#### Biological Responses to Tobacco Smoke Exposure in Ill Children
```{r}

selectInput("categorical_variable",
            label = "Categorical Variable", 
            choices = categorical_variable)

radioButtons("biomarker_type", 
             label = "Biological Response Type", 
              choices = biomarker_type, 
             selected = "c_reactive_protein(pg/mL)")
sliderInput(
    "child_smoke_exposure", 
    label = "Child's Cigarette Exposed Per Day", 
    max= 224, 
    min= 0, 
    value = c(0,224)
)

radioButtons("time", 
             label = "Time", 
              choices = Time, 
             selected = "baseline")
```


Row {data-width=150}
--------------------------------------
### Sample Size to Caculate Biomarker Concentration  %{data-width=35%}

```{r}
renderValueBox({

sample_size <- shiny_app_data %>%
    filter(biomarker_type == input[["biomarker_type"]], 
           week == input[["time"]], 
           child_smoke_exposure >= input[["child_smoke_exposure"]][1], 
           child_smoke_exposure <= input[["child_smoke_exposure"]][2]
            ) %>%  
            drop_na(biomarker_conc) %>% 
            nrow()
            
valueBox(value = sample_size , 
         caption = "Sample Size to Caculate Biomarker Concentration",
         icon = "fa-users")
})

```

### Selected Biomarker Mean Concentration %{data-width=35%}
```{r}
renderValueBox({

mean_conc <- shiny_app_data %>%
    filter(biomarker_type == input[["biomarker_type"]], 
           week == input[["time"]], 
           child_smoke_exposure >= input[["child_smoke_exposure"]][1], 
           child_smoke_exposure <= input[["child_smoke_exposure"]][2]
            ) %>%  
            drop_na(biomarker_conc) %>% 
      summarise(biomarker_conc = round(mean(biomarker_conc),2))
            
valueBox(value = mean_conc , 
         caption = "Selected Biomarker Mean Concentration", 
     icon="fa-flask")
     })

```


### Children Diseases Count by Selected Category
```{r}
renderPlotly({

diseaes_count = shiny_app_data %>%
    filter(week == input[["time"]], 
           child_smoke_exposure >= input[["child_smoke_exposure"]][1], 
           child_smoke_exposure <= input[["child_smoke_exposure"]][2]
            ) %>% 
  distinct(human_id, .keep_all = TRUE) %>%  
  group_by(get(input$categorical_variable)) %>% 
  mutate(asthma = sum(asthma), 
            reactive_airway = sum(reactive_airway), 
            bronchiolitis = sum(bronchiolitis), 
            pneumonia = sum(pneumonia)) %>% 
  pivot_longer(
    cols= c(asthma, reactive_airway ,bronchiolitis,pneumonia), 
    names_to = "diseases", 
    values_to = "count"
  ) %>% 
  select(diseases, count, input$categorical_variable) %>%  
  distinct() %>% 
  ggplot(aes(fill= get(input$categorical_variable),
             y= count, 
             x= diseases))+
  geom_bar(stat = "identity",
           position = "dodge")+
  scale_fill_discrete(name=NULL)
    
diseaes_count %>%
  ggplotly()%>%
    layout(showlegend = TRUE, legend = list(font = list(size = 7)))
     })

```

Row
----------------------------------

### Children Distribution of Biomarker Conc by Selected Category

```{r}

renderPlotly({
  
 shiny_app_data  %>%
    filter(biomarker_type == input[["biomarker_type"]], 
           week == input[["time"]], 
           child_smoke_exposure >= input[["child_smoke_exposure"]][1], 
           child_smoke_exposure <= input[["child_smoke_exposure"]][2]
            ) %>% 
   plot_ly(   
              y= ~biomarker_conc, 
              color = ~  get(input$categorical_variable),
              type = "box") %>%
    layout(showlegend = TRUE, legend = list(font = list(size = 10)))%>% 
    layout(xaxis= list(showticklabels = FALSE, title = 'Selected Categorical Variable'))
})

```


### Children Smoke Exposure & Biomarkers Conc by Selected Category
```{r}

renderPlotly({

 shiny_app_data  %>%
    filter(biomarker_type == input[["biomarker_type"]], 
           week == input[["time"]], 
           child_smoke_exposure >= input[["child_smoke_exposure"]][1], 
           child_smoke_exposure <= input[["child_smoke_exposure"]][2]
            ) %>% 
 plot_ly(
    x =  ~child_smoke_exposure,
    y = ~ biomarker_conc,
    type = "scatter", 
    color = ~get(input$categorical_variable))%>%
    layout(showlegend = TRUE, legend = list(font = list(size = 10)))
    
})
```

More
=====================================

```{r Data Cleaning for More, include=FALSE}
test = clean_data  %>% 
    select(-caregiver_ecigar_baseline, -caregiver_ecigar_followup, 
           -caregiver_ecigar_use_baseline, -caregiver_ecigar_use_followup, 
           -caregiver_cigar_baseline, -caregiver_cigar_followup) %>% 
  rename(mean_cotinine_baseline = child_mean_conc_cotinine_baseline, 
         mean_cotinine_followup = child_mean_conc_cotinine_followup) %>% 
  mutate(child_smoke_exposure_change =  child_smoke_exposure_followup - child_smoke_exposure_baseline, 
         cotinine_conc_change = cotinine_followup - cotinine_baseline,
         interleukin_10_conc_change =  interleukin_10_followup - interleukin_10_baseline, 
         interleukin_8_conc_change = interleukin_8_followup - interleukin_8_baseline, 
         c_reactive_protein_conc_change = c_reactive_protein_followup -c_reactive_protein_baseline, 
          mean_cotinine_conc_change = mean_cotinine_followup - mean_cotinine_baseline
         ) %>% 
  drop_na(child_smoke_exposure_change)

```

Inputs {.sidebar}
-------------------------------------
#### Biological Responses to Tobacco Smoke Exposure in Ill Children

```{r}
selectInput("categorical_variable3",
            label = "Categorical Variable", 
            choices =c("caregiver_sex","caregiver_group", "caregiver_race", "caregiver_age", "caregiver_education",  "caregiver_smoking_status","caregiver_household","caregiver_relation", "child_race", "child_sex", "birth_outcome", "none"), 
            selected = "none")

radioButtons("biomarker_type3", 
             label = "Biological Response Type", 
              choices = biomarker_type, 
             selected = "c_reactive_protein(pg/mL)")

sliderInput(
    "smoke_exposure_change", 
    label = "Child's Smoke Exposure Change During the Study", 
    max= 50, 
    min= -179, 
    value = c(-179,50)
)
```

Row {data-height=700}
--------

###  Distribution of Selected Children Biomarker Conc Change Under Selected Level of Smoke Exposure Change
```{r}

test2 = test %>%  
   rename_all(~stringr::str_replace(.,"_conc_change",""))  %>% 
  pivot_longer(
    cols = c(cotinine, interleukin_10, interleukin_8, c_reactive_protein, mean_cotinine), 
    values_to = "conc_change", 
    names_to = "biomarker_type" 
  ) %>% 
  drop_na(conc_change) %>%  
  mutate(biomarker_type = case_when(
    biomarker_type == "c_reactive_protein" ~ "c_reactive_protein(pg/mL)", 
    biomarker_type == "interleukin_8" ~ "interleukin_8(pg/mL)",
     biomarker_type == "interleukin_10" ~ "interleukin_10(pg/mL)",
     biomarker_type == "cotinine" ~ "cotinine(ng/mL)", 
      biomarker_type == "mean_cotinine" ~"mean_cotinine(ng/mL)"
  ))


renderPlotly({
  
if (input$categorical_variable3 != "none") {

p = test2 %>%
    filter(biomarker_type == input[["biomarker_type3"]], 
           child_smoke_exposure_change >= input[["smoke_exposure_change"]][1], 
           child_smoke_exposure_change <= input[["smoke_exposure_change"]][2])%>% 
   plot_ly(   
              y= ~ conc_change, 
              color = ~  get(input$categorical_variable3),
              type = "box") %>%
    layout(showlegend = TRUE, legend = list(font = list(size = 10)))%>% 
    layout(xaxis= list(showticklabels = FALSE))
}
  
if (input$categorical_variable3 == "none") {
  p = test2 %>%
    filter(biomarker_type == input[["biomarker_type3"]], 
           child_smoke_exposure_change >= input[["smoke_exposure_change"]][1], 
           child_smoke_exposure_change <= input[["smoke_exposure_change"]][2])%>% 
   plot_ly(   
              y= ~ conc_change, 
              type = "box") %>% 
    layout(xaxis= list(showticklabels = FALSE), title = 'Selected Categorical Variable')
}
  
p

})



```

### Scatterplot of Selected Children Biomarker Conc Change with Selected Level of Smoke Exposure Change
```{r}

renderPlotly({
  
if (input$categorical_variable3 != "none") {
     p2 <- test2 %>%
    filter(biomarker_type == input[["biomarker_type3"]], 
           child_smoke_exposure_change >= input[["smoke_exposure_change"]][1], 
           child_smoke_exposure_change <= input[["smoke_exposure_change"]][2])%>% 
         plot_ly(
                x = ~ child_smoke_exposure_change, 
                y = ~ conc_change,
                color = ~ get(input$categorical_variable3)) 
       
       }
    
if (input$categorical_variable3 == "none") {

  p2 <- test2 %>%
    filter(biomarker_type == input[["biomarker_type3"]], 
           child_smoke_exposure_change >= input[["smoke_exposure_change"]][1], 
           child_smoke_exposure_change <= input[["smoke_exposure_change"]][2])%>% 
        plot_ly(
                x = ~ child_smoke_exposure_change, 
                y = ~ conc_change)

}
  
p2
})
```

Row {data-height =300}
--------

### Table Summarizing Selected Children Biomarker Conc Change Under Selected Level of Smoke Exposure Change
```{r}
renderDataTable({
datatable( test2 %>%
    filter(biomarker_type  == input[["biomarker_type3"]], 
           child_smoke_exposure_change >= input[["smoke_exposure_change"]][1], 
           child_smoke_exposure_change <= input[["smoke_exposure_change"]][2]) %>% 
    select(human_id,child_smoke_exposure_change,conc_change) %>% 
    arrange(desc(conc_change)) %>% 
      distinct()
,options = list(scrollY=TRUE,
                bPaginate = FALSE,
                searching = FALSE, 
                info = FALSE),
            fillContainer = TRUE)
})
```


About
===================================== 

Inputs {.sidebar}
-------------------------------------
#### Biological Responses to Tobacco Smoke Exposure in Ill Children

```{r}

selectInput("categorical_variable2",
            label = "Categorical Variable", 
            choices = c("caregiver_sex","caregiver_group", "caregiver_race","caregiver_age","caregiver_education",  "caregiver_smoking_status","caregiver_household","caregiver_relation", "child_race", "child_sex", "birth_outcome", "asthma", "bronchiolitis", "reactive_airway", "pneumonia"))

radioButtons("time2", 
             label = "Time", 
              choices = c("baseline", "followup"), 
             selected = "baseline")

```


Row{data-height=250}
--------

### Sample Size  %{data-width=5%}
```{r}
renderValueBox({
valueBox(value = 411, 
         caption = "Participants <br> in total", 
     icon="fa-users", 
     color = "navy")
     })
```

### Week %{data-width=5%}
```{r}
renderValueBox({
valueBox(value = 6, 
         caption = "Weeks experiment", 
     icon="fa-clock", 
     color = "navy")
     })
```

### About the Study 

The CHEAR project will use sensitive LCMS techniques to analyze cotinine, a measure of tobacco smoke exposure, in child saliva samples collected from ill children at baseline and six-weeks after baseline. Investigators will explore the associations between different levels of tobacco smoke exposure and a broad range of biological outcomes associated with immune system dysregulation based on biomarkers of inflammatory responses and findings from targeted and untargeted metabolomics.

### Sample Size Distribution 
```{r}
renderPlotly({
clean_data %>%  
   group_by_(input$categorical_variable2)%>% 
  summarise(count=n()) %>% 
plot_ly(labels = ~get(input$categorical_variable2), values = ~count, type = 'pie',
        textposition = 'inside',
        textinfo = 'label+percent',
        insidetextfont = list(color = '#FFFFFF'))%>%
    layout(showlegend = TRUE, legend = list(font = list(size = 8)))
 })

```


Row  {data-height=180}
--------------------------------------
### Cotinine
```{r}
renderValueBox({
  valueBox(value = tags$p("Cotinine (ng/mL)", style = "font-size: 50%;"),
         caption = "A product formed after the chemical nicotine enters the body",
     icon="fa-flask")
     })

```

### 2
```{r}
renderValueBox({
valueBox(value = tags$p("C-Reactive Protein (pg/mL)", style = "font-size: 50%;"),
         caption = " A protein produced by the liver. Its level increases in response to inflammation", 
     icon="fa-flask")
     })

```

### 3
```{r}
renderValueBox({
valueBox(value = tags$p("Interleukin-8 (pg/mL)" , style = "font-size: 50%;"),
         caption = " A chemokine made by macrophages and other cell types", 
     icon="fa-flask")
     })

```

### 4
```{r}
renderValueBox({
valueBox(value = tags$p("Interleukin-10 (pg/mL)" , style = "font-size: 50%;"),
         caption = "A chemokine made by several types of cells, including activated T lymphocytes, monocytes, B cells and nonhematopoietic sources", 
     icon="fa-flask")
     })

```


Row {data-height = 500}
--------------------------------------
### Caregivers' Smoking Distribution by Selected Category and Time
```{r}
renderPlotly({
  
clean_data %>%
    select(-caregiver_ecigar_baseline, -caregiver_ecigar_followup, 
           -caregiver_ecigar_use_baseline, -caregiver_ecigar_use_followup, 
           -child_smoke_exposure_baseline, - child_smoke_exposure_followup) %>% 
  pivot_longer(
    cols= c(caregiver_cigar_baseline,caregiver_cigar_followup), 
    names_to = "week", 
    names_prefix = "caregiver_cigar_", 
    values_to = "cigarette_per_day"
  ) %>% 
    filter(week == input[["time2"]]) %>% 
  plot_ly(
    y = ~cigarette_per_day,
    split = ~ get(input$categorical_variable2),
    type = 'violin',
    box = list(
      visible = T
    ),
    meanline = list(
      visible = T
    )
  ) %>%
    layout(showlegend = TRUE, 
           legend = list(font = list(size = 8)))
})

```


### Caregivers' Daily Cigarette Intake Change during Baseline and Followup by Selected Category 
```{r}

renderPlotly({
  
cigarette_intake_change = clean_data %>% 
  select(-caregiver_ecigar_baseline, -caregiver_ecigar_followup, 
           -caregiver_ecigar_use_baseline, -caregiver_ecigar_use_followup, 
           -child_smoke_exposure_baseline, - child_smoke_exposure_followup) %>% 
  mutate(cigarette_intake_change = caregiver_cigar_followup- caregiver_cigar_baseline, 
         asthma = as.factor(asthma), 
         bronchiolitis = as.factor(bronchiolitis), 
         reactive_airway = as.factor(reactive_airway), 
         pneumonia = as.factor(pneumonia)
         ) %>% 
  drop_na(cigarette_intake_change) %>% 
  ggplot(aes(x=cigarette_intake_change,
             group=get(input$categorical_variable2), 
             fill=get(input$categorical_variable2))) +
    geom_density(adjust=1.5,
                 alpha=.3)+
  geom_vline(xintercept=0, 
             size=0.4,
             color="red", 
             alpha =.5,
             linetype = "dotted")

cigarette_intake_change %>%
  ggplotly()%>%
    layout(showlegend = TRUE, 
           legend = list(font = list(size = 8),title = list(text = "")))
})

```





